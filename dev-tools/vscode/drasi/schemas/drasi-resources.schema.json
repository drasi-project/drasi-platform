{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "required": [
    "apiVersion",
    "kind",
    "name",
    "spec"
  ],
  "properties": {
    "apiVersion": {
      "type": "string",
      "enum": [
        "v1"
      ]
    },
    "kind": {
      "type": "string",
      "enum": [
        "ContinuousQuery",
        "Source",
        "Reaction"
      ]
    },
    "name": {
      "type": "string",
      "pattern": "^[a-z0-9]([-a-z0-9]*[a-z0-9])?$"
    }
  },
  "allOf": [
    {
      "if": {
        "properties": {
          "kind": {
            "const": "ContinuousQuery"
          }
        }
      },
      "then": {
        "$schema": "http://json-schema.org/draft-07/schema#",
        "title": "Drasi ContinuousQuery",
        "description": "A continuous query that processes data streams",
        "type": "object",
        "required": [
          "apiVersion",
          "kind",
          "name",
          "spec"
        ],
        "properties": {
          "apiVersion": {
            "type": "string",
            "enum": [
              "v1"
            ],
            "description": "API version of the resource"
          },
          "kind": {
            "type": "string",
            "const": "ContinuousQuery",
            "description": "Resource type"
          },
          "name": {
            "type": "string",
            "description": "Unique name for the continuous query",
            "pattern": "^[a-z0-9]([-a-z0-9]*[a-z0-9])?$"
          },
          "spec": {
            "type": "object",
            "required": [
              "mode",
              "sources",
              "query"
            ],
            "properties": {
              "mode": {
                "type": "string",
                "enum": [
                  "query"
                ],
                "description": "Query execution mode"
              },
              "container": {
                "type": "string",
                "description": "Query container name (optional)",
                "pattern": "^[a-z0-9]([-a-z0-9]*[a-z0-9])?$"
              },
              "queryLanguage": {
                "type": "string",
                "enum": [
                  "Cypher",
                  "GQL"
                ],
                "description": "Query language to use",
                "default": "GQL"
              },
              "storageProfile": {
                "type": "string",
                "description": "Storage profile name for this query"
              },
              "sources": {
                "type": "object",
                "required": [
                  "subscriptions"
                ],
                "properties": {
                  "subscriptions": {
                    "type": "array",
                    "description": "List of source subscriptions",
                    "minItems": 1,
                    "items": {
                      "type": "object",
                      "required": [
                        "id"
                      ],
                      "properties": {
                        "id": {
                          "type": "string",
                          "description": "Source ID to subscribe to"
                        },
                        "pipeline": {
                          "type": "array",
                          "description": "Middleware pipeline to apply",
                          "items": {
                            "type": "string"
                          }
                        },
                        "nodes": {
                          "type": "array",
                          "description": "Filter by specific node labels",
                          "items": {
                            "type": "object",
                            "required": [
                              "sourceLabel"
                            ],
                            "properties": {
                              "sourceLabel": {
                                "type": "string",
                                "description": "Node label to filter"
                              }
                            }
                          }
                        },
                        "relations": {
                          "type": "array",
                          "description": "Filter by specific relationship labels",
                          "items": {
                            "type": "object",
                            "required": [
                              "sourceLabel"
                            ],
                            "properties": {
                              "sourceLabel": {
                                "type": "string",
                                "description": "Relationship label to filter"
                              }
                            }
                          }
                        }
                      }
                    }
                  },
                  "joins": {
                    "type": "array",
                    "description": "Cross-source join definitions",
                    "items": {
                      "type": "object",
                      "required": [
                        "id",
                        "keys"
                      ],
                      "properties": {
                        "id": {
                          "type": "string",
                          "description": "Join identifier"
                        },
                        "keys": {
                          "type": "array",
                          "description": "Join key mappings",
                          "minItems": 1,
                          "items": {
                            "type": "object",
                            "required": [
                              "label",
                              "property"
                            ],
                            "properties": {
                              "label": {
                                "type": "string",
                                "description": "Node/relationship label"
                              },
                              "property": {
                                "type": "string",
                                "description": "Property name to join on"
                              }
                            }
                          }
                        }
                      }
                    }
                  },
                  "middleware": {
                    "type": "array",
                    "description": "Middleware configurations",
                    "items": {
                      "type": "object",
                      "required": [
                        "kind",
                        "name"
                      ],
                      "properties": {
                        "kind": {
                          "type": "string",
                          "description": "Middleware type (e.g., 'jq')"
                        },
                        "name": {
                          "type": "string",
                          "description": "Middleware instance name"
                        }
                      },
                      "additionalProperties": true
                    }
                  }
                }
              },
              "query": {
                "type": "string",
                "description": "Cypher or GQL query string"
              },
              "view": {
                "type": "object",
                "description": "Materialized view configuration",
                "required": [
                  "enabled",
                  "retentionPolicy"
                ],
                "properties": {
                  "enabled": {
                    "type": "boolean",
                    "description": "Enable materialized view"
                  },
                  "retentionPolicy": {
                    "description": "Data retention policy",
                    "oneOf": [
                      {
                        "type": "string",
                        "enum": [
                          "latest",
                          "all"
                        ],
                        "description": "Built-in retention policy"
                      },
                      {
                        "type": "object",
                        "required": [
                          "expire"
                        ],
                        "properties": {
                          "expire": {
                            "type": "object",
                            "required": [
                              "afterSeconds"
                            ],
                            "properties": {
                              "afterSeconds": {
                                "type": "integer",
                                "minimum": 0,
                                "description": "Expire results after N seconds"
                              }
                            }
                          }
                        }
                      }
                    ]
                  }
                }
              }
            }
          }
        }
      }
    },
    {
      "if": {
        "properties": {
          "kind": {
            "const": "Source"
          }
        }
      },
      "then": {
        "$schema": "http://json-schema.org/draft-07/schema#",
        "title": "Drasi Source",
        "description": "A data source that provides events to continuous queries",
        "type": "object",
        "required": [
          "apiVersion",
          "kind",
          "name",
          "spec"
        ],
        "properties": {
          "apiVersion": {
            "type": "string",
            "enum": [
              "v1"
            ],
            "description": "API version of the resource"
          },
          "kind": {
            "type": "string",
            "const": "Source",
            "description": "Resource type"
          },
          "name": {
            "type": "string",
            "description": "Unique name for the source",
            "pattern": "^[a-z0-9]([-a-z0-9]*[a-z0-9])?$"
          },
          "spec": {
            "type": "object",
            "required": [
              "kind"
            ],
            "properties": {
              "kind": {
                "type": "string",
                "description": "Source provider type (e.g., PostgreSQL, CosmosDB, Kubernetes)"
              },
              "identity": {
                "description": "Authentication configuration",
                "oneOf": [
                  {
                    "type": "object",
                    "required": [
                      "kind",
                      "connectionString"
                    ],
                    "properties": {
                      "kind": {
                        "type": "string",
                        "const": "ConnectionString"
                      },
                      "connectionString": {
                        "$ref": "#/definitions/source_configValue"
                      }
                    }
                  },
                  {
                    "type": "object",
                    "required": [
                      "kind",
                      "clientId"
                    ],
                    "properties": {
                      "kind": {
                        "type": "string",
                        "const": "MicrosoftEntraWorkloadID"
                      },
                      "clientId": {
                        "type": "string",
                        "description": "Microsoft Entra Workload ID client ID"
                      }
                    }
                  },
                  {
                    "type": "object",
                    "required": [
                      "kind",
                      "tenantId",
                      "clientId"
                    ],
                    "properties": {
                      "kind": {
                        "type": "string",
                        "const": "MicrosoftEntraApplication"
                      },
                      "tenantId": {
                        "$ref": "#/definitions/source_configValue"
                      },
                      "clientId": {
                        "$ref": "#/definitions/source_configValue"
                      },
                      "secret": {
                        "$ref": "#/definitions/source_configValue"
                      },
                      "certificate": {
                        "$ref": "#/definitions/source_configValue"
                      }
                    }
                  },
                  {
                    "type": "object",
                    "required": [
                      "kind",
                      "accessKey"
                    ],
                    "properties": {
                      "kind": {
                        "type": "string",
                        "const": "AccessKey"
                      },
                      "accessKey": {
                        "$ref": "#/definitions/source_configValue"
                      }
                    }
                  },
                  {
                    "type": "object",
                    "required": [
                      "kind",
                      "roleArn"
                    ],
                    "properties": {
                      "kind": {
                        "type": "string",
                        "const": "AwsIamRole"
                      },
                      "roleArn": {
                        "$ref": "#/definitions/source_configValue"
                      }
                    }
                  },
                  {
                    "type": "object",
                    "required": [
                      "kind",
                      "accessKeyId",
                      "secretAccessKey",
                      "region"
                    ],
                    "properties": {
                      "kind": {
                        "type": "string",
                        "const": "AwsIamAccessKey"
                      },
                      "accessKeyId": {
                        "$ref": "#/definitions/source_configValue"
                      },
                      "secretAccessKey": {
                        "$ref": "#/definitions/source_configValue"
                      },
                      "region": {
                        "$ref": "#/definitions/source_configValue"
                      }
                    }
                  }
                ]
              },
              "properties": {
                "type": "object",
                "description": "Provider-specific configuration",
                "additionalProperties": true
              },
              "services": {
                "type": "object",
                "description": "Service configurations",
                "additionalProperties": {
                  "$ref": "#/definitions/source_serviceConfig"
                }
              }
            }
          }
        }
      }
    },
    {
      "if": {
        "properties": {
          "kind": {
            "const": "Reaction"
          }
        }
      },
      "then": {
        "$schema": "http://json-schema.org/draft-07/schema#",
        "title": "Drasi Reaction",
        "description": "A reaction that responds to continuous query results",
        "type": "object",
        "required": [
          "apiVersion",
          "kind",
          "name",
          "spec"
        ],
        "properties": {
          "apiVersion": {
            "type": "string",
            "enum": [
              "v1"
            ],
            "description": "API version of the resource"
          },
          "kind": {
            "type": "string",
            "const": "Reaction",
            "description": "Resource type"
          },
          "name": {
            "type": "string",
            "description": "Unique name for the reaction",
            "pattern": "^[a-z0-9]([-a-z0-9]*[a-z0-9])?$"
          },
          "spec": {
            "type": "object",
            "required": [
              "kind",
              "queries"
            ],
            "properties": {
              "kind": {
                "type": "string",
                "description": "Reaction provider type (e.g., Debug, Webhook, StorageQueue)"
              },
              "queries": {
                "type": "object",
                "description": "Query subscriptions (queryName -> optional filter)",
                "additionalProperties": {
                  "oneOf": [
                    {
                      "type": "string",
                      "description": "Filter expression"
                    },
                    {
                      "type": "null",
                      "description": "No filter"
                    }
                  ]
                },
                "minProperties": 1
              },
              "tag": {
                "type": "string",
                "description": "Version tag for the reaction"
              },
              "identity": {
                "description": "Authentication configuration",
                "oneOf": [
                  {
                    "type": "object",
                    "required": [
                      "kind",
                      "connectionString"
                    ],
                    "properties": {
                      "kind": {
                        "type": "string",
                        "const": "ConnectionString"
                      },
                      "connectionString": {
                        "$ref": "#/definitions/reaction_configValue"
                      }
                    }
                  },
                  {
                    "type": "object",
                    "required": [
                      "kind",
                      "clientId"
                    ],
                    "properties": {
                      "kind": {
                        "type": "string",
                        "const": "MicrosoftEntraWorkloadID"
                      },
                      "clientId": {
                        "type": "string",
                        "description": "Microsoft Entra Workload ID client ID"
                      }
                    }
                  },
                  {
                    "type": "object",
                    "required": [
                      "kind",
                      "tenantId",
                      "clientId"
                    ],
                    "properties": {
                      "kind": {
                        "type": "string",
                        "const": "MicrosoftEntraApplication"
                      },
                      "tenantId": {
                        "$ref": "#/definitions/reaction_configValue"
                      },
                      "clientId": {
                        "$ref": "#/definitions/reaction_configValue"
                      },
                      "secret": {
                        "$ref": "#/definitions/reaction_configValue"
                      },
                      "certificate": {
                        "$ref": "#/definitions/reaction_configValue"
                      }
                    }
                  },
                  {
                    "type": "object",
                    "required": [
                      "kind",
                      "accessKey"
                    ],
                    "properties": {
                      "kind": {
                        "type": "string",
                        "const": "AccessKey"
                      },
                      "accessKey": {
                        "$ref": "#/definitions/reaction_configValue"
                      }
                    }
                  },
                  {
                    "type": "object",
                    "required": [
                      "kind",
                      "roleArn"
                    ],
                    "properties": {
                      "kind": {
                        "type": "string",
                        "const": "AwsIamRole"
                      },
                      "roleArn": {
                        "$ref": "#/definitions/reaction_configValue"
                      }
                    }
                  },
                  {
                    "type": "object",
                    "required": [
                      "kind",
                      "accessKeyId",
                      "secretAccessKey",
                      "region"
                    ],
                    "properties": {
                      "kind": {
                        "type": "string",
                        "const": "AwsIamAccessKey"
                      },
                      "accessKeyId": {
                        "$ref": "#/definitions/reaction_configValue"
                      },
                      "secretAccessKey": {
                        "$ref": "#/definitions/reaction_configValue"
                      },
                      "region": {
                        "$ref": "#/definitions/reaction_configValue"
                      }
                    }
                  }
                ]
              },
              "properties": {
                "type": "object",
                "description": "Provider-specific configuration",
                "additionalProperties": true
              },
              "services": {
                "type": "object",
                "description": "Service configurations",
                "additionalProperties": {
                  "$ref": "#/definitions/reaction_serviceConfig"
                }
              }
            }
          }
        }
      }
    }
  ],
  "definitions": {
    "source_configValue": {
      "description": "Configuration value that can be inline or from a secret",
      "oneOf": [
        {
          "type": "object",
          "required": [
            "kind",
            "value"
          ],
          "properties": {
            "kind": {
              "type": "string",
              "const": "Inline"
            },
            "value": {
              "description": "Inline value (string, number, boolean, or list)"
            }
          }
        },
        {
          "type": "object",
          "required": [
            "kind",
            "name",
            "key"
          ],
          "properties": {
            "kind": {
              "type": "string",
              "const": "Secret"
            },
            "name": {
              "type": "string",
              "description": "Secret name"
            },
            "key": {
              "type": "string",
              "description": "Key within the secret"
            }
          }
        },
        {
          "type": "string",
          "description": "Simple string value"
        },
        {
          "type": "number",
          "description": "Simple numeric value"
        },
        {
          "type": "boolean",
          "description": "Simple boolean value"
        }
      ]
    },
    "source_serviceConfig": {
      "type": "object",
      "properties": {
        "properties": {
          "type": "object",
          "description": "Service-specific properties"
        },
        "endpoints": {
          "type": "object",
          "description": "Endpoint configurations",
          "additionalProperties": {
            "type": "object",
            "required": [
              "setting",
              "target"
            ],
            "properties": {
              "setting": {
                "type": "string",
                "enum": [
                  "internal",
                  "external"
                ],
                "description": "Endpoint visibility"
              },
              "target": {
                "type": "string",
                "description": "Target endpoint address"
              }
            }
          }
        },
        "dapr": {
          "type": "object",
          "description": "Dapr configuration",
          "additionalProperties": true
        }
      }
    },
    "reaction_configValue": {
      "description": "Configuration value that can be inline or from a secret",
      "oneOf": [
        {
          "type": "object",
          "required": [
            "kind",
            "value"
          ],
          "properties": {
            "kind": {
              "type": "string",
              "const": "Inline"
            },
            "value": {
              "description": "Inline value (string, number, boolean, or list)"
            }
          }
        },
        {
          "type": "object",
          "required": [
            "kind",
            "name",
            "key"
          ],
          "properties": {
            "kind": {
              "type": "string",
              "const": "Secret"
            },
            "name": {
              "type": "string",
              "description": "Secret name"
            },
            "key": {
              "type": "string",
              "description": "Key within the secret"
            }
          }
        },
        {
          "type": "string",
          "description": "Simple string value"
        },
        {
          "type": "number",
          "description": "Simple numeric value"
        },
        {
          "type": "boolean",
          "description": "Simple boolean value"
        }
      ]
    },
    "reaction_serviceConfig": {
      "type": "object",
      "properties": {
        "properties": {
          "type": "object",
          "description": "Service-specific properties"
        },
        "endpoints": {
          "type": "object",
          "description": "Endpoint configurations",
          "additionalProperties": {
            "type": "object",
            "required": [
              "setting",
              "target"
            ],
            "properties": {
              "setting": {
                "type": "string",
                "enum": [
                  "internal",
                  "external"
                ],
                "description": "Endpoint visibility"
              },
              "target": {
                "type": "string",
                "description": "Target endpoint address"
              }
            }
          }
        },
        "dapr": {
          "type": "object",
          "description": "Dapr configuration",
          "additionalProperties": true
        }
      }
    }
  }
}